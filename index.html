<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Votación - App del Gerente</title>
    
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56e8;
            --secondary-color: #7209b7;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --gray-text: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 480px;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        
        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            margin-top: 10px;
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }

        .secondary-btn {
                background-color: white;
                color: var(--primary-color);
                border: 1px solid var(--primary-color);
                padding: 14px;
                border-radius: 8px;
                cursor: pointer;
                width: 100%;
                font-size: 16px;
                font-weight: 500;
                transition: var(--transition);
                margin-top: 10px;
            }

            .secondary-btn:hover {
                background-color: rgba(67, 97, 238, 0.1);
            }

            #ver-propuestas {
                margin-top: 15px;
            }
        
        .options {
            margin-top: 25px;
            display: none;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .radio-option:hover {
            background-color: #f8f9fa;
        }
        
        .radio-option input[type="radio"] {
            width: auto;
            margin-right: 12px;
        }
        
        .nombres-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .nombre-item {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        
        .nombre-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .nombre-item input[type="radio"] {
            width: auto;
            margin-right: 12px;
        }
        
        .nombre-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .votos {
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .error {
            color: #e63946;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .success {
            color: #2a9d8f;
            font-size: 16px;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background-color: rgba(42, 157, 143, 0.1);
            border-radius: 8px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -1px;
        }

        /* Estilo para la imagen logo */
/* Estilo para la imagen logo */
.logo-img {
    max-width: 245px; /* 50% del ancho original (490px ÷ 2) */
    width: 60%; /* También puedes usar porcentaje directamente */
    height: auto; /* Mantiene la proporción */
    margin: 0 auto;
    display: block;
}
/* Ajuste para logo en dispositivos móviles */
/* Ajuste para logo en dispositivos móviles */
@media (max-width: 576px) {
    .logo-img {
        width: 50%; /* 40% del ancho del contenedor */
        max-width: 196px; /* Aproximadamente 40% del tamaño original */
    }
}
        
        .logo-subtitle {
            font-size: 0.9rem;
            color: var(--gray-text);
        }
        
        .progress-bar {
            height: 4px;
            background-color: #e1e5eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 33%;
            transition: var(--transition);
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }
        
        /* Media queries para responsividad */
        @media (max-width: 576px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            h2 {
                font-size: 1.2rem;
            }
            
            input, select, button {
                padding: 12px;
                font-size: 15px;
            }
        }


        /* Estilo específico para la pantalla de consulta de propuestas */
            #propuestas-consulta .nombre-info {
                padding: 0 10px; /* Agregar padding horizontal */
                width: 100%; /* Asegurar que ocupe todo el ancho disponible */
                justify-content: space-between; /* Distribuir el contenido */
            }

            #propuestas-consulta .nombre-info strong {
                margin-right: 20px; /* Espacio entre el nombre y los votos */
            }

            #propuestas-consulta .nombre-item {
                margin-bottom: 12px; /* Mayor separación vertical entre elementos */
            }

            /* Estilo para tooltip de información del proponente */
            .nombre-item {
                position: relative; /* Para posicionar el tooltip */
            }

           

            .votos {
                font-weight: bold;
                color: var(--primary-color);
                background: rgba(67, 97, 238, 0.1);
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 14px;
                cursor: pointer; /* Cambiar cursor a mano */
                transition: background-color 0.3s;
            }

            .votos:hover {
                background: rgba(67, 97, 238, 0.2);
            }

            .votos.active {
                background: rgba(67, 97, 238, 0.4);
                color: #fff;
            }
           

                /* Contenedor con altura limitada y scroll para las listas de propuestas */
                .nombres-list {
                    max-height: 300px;
                    overflow-y: auto;
                    scrollbar-width: thin;
                    scrollbar-color: var(--primary-color) #f0f0f0;
                    padding-right: 5px;
                    position: relative; /* Añadir posicionamiento relativo */
                    z-index: 1; /* Asignar z-index básico */
                }

                /* Asegurar que todos los items tengan un z-index adecuado */
                #nombres-list .nombre-item:first-child,
                #propuestas-consulta .nombre-item:first-child {
                    z-index: 5; /* Z-index para primer elemento */
                }

                /* Estilo para el scrollbar (Chrome, Edge, Safari) */
                .nombres-list::-webkit-scrollbar {
                    width: 8px;
                }

                .nombres-list::-webkit-scrollbar-track {
                    background: #f0f0f0;
                    border-radius: 10px;
                }

                .nombres-list::-webkit-scrollbar-thumb {
                    background-color: var(--primary-color);
                    border-radius: 10px;
                }

              /* Estilos para el tooltip global */
                .tooltip-global {
                    position: fixed;
                    display: none;
                    background-color: var(--primary-color);
                    color: white;
                    padding: 6px 10px; /* Reducido el padding */
                    border-radius: 6px;
                    font-size: 12px; /* Letra más pequeña */
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                    z-index: 9999;
                    max-width: 180px; /* Tooltip más estrecho */
                    text-align: center;
                    pointer-events: none;
                }

                .tooltip-global:after {
                    content: '';
                    position: absolute;
                    bottom: -10px;
                    left: 50%;
                    transform: translateX(-50%);
                    border-width: 5px;
                    border-style: solid;
                    border-color: var(--primary-color) transparent transparent transparent;
                }


                /* Contenedor principal del autocomplete */
                    .autocomplete-container {
                        position: relative;
                        width: 100%;
                    }

                    /* Estilos para el input de búsqueda */
                    .autocomplete-input {
                        width: 100%;
                        padding: 12px 15px;
                        border: 1px solid #e1e5eb;
                        border-radius: 8px;
                        font-size: 16px;
                        transition: var(--transition);
                    }

                    .autocomplete-input:focus {
                        outline: none;
                        border-color: var(--primary-color);
                        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
                    }

                    /* Lista de sugerencias */
                    .autocomplete-items {
                        position: absolute;
                        border: 1px solid #e1e5eb;
                        border-top: none;
                        z-index: 99;
                        top: 100%;
                        left: 0;
                        right: 0;
                        max-height: 250px;
                        overflow-y: auto;
                        background-color: #fff;
                        border-radius: 0 0 8px 8px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    }

                    /* Elementos individuales de la lista */
                    .autocomplete-item {
                        padding: 10px 15px;
                        cursor: pointer;
                        transition: var(--transition);
                    }

                    .autocomplete-item:hover {
                        background-color: rgba(67, 97, 238, 0.1);
                    }

                    /* Elemento seleccionado */
                    .autocomplete-item.selected {
                        background-color: rgba(67, 97, 238, 0.2);
                    }

                    /* Resaltar texto coincidente */
                    .highlight {
                        font-weight: bold;
                        color: var(--primary-color);
                    }

                    /* Estilos para mobile */
                    @media (max-width: 576px) {
                        .autocomplete-items {
                            max-height: 200px;
                        }
                    }



                    /* Estilos para el botón "¿Cómo participar?" */
.help-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    z-index: 10;
}

.help-button:hover {
    background-color: var(--primary-hover);
    transform: translateY(-2px);
}

/* Estilos para la ventana modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    max-width: 500px;
    width: 90%;
    position: relative;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {opacity: 0; transform: translateY(-20px);}
    to {opacity: 1; transform: translateY(0);}
}

.modal h2 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--primary-color);
}

.modal p {
    margin-bottom: 15px;
    line-height: 1.6;
}

.modal ul {
    margin-bottom: 15px;
    margin-left: 20px;
}

.modal ul li {
    margin-bottom: 10px;
}

.modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 25px;
}

.whatsapp-btn {
    background-color: #25D366;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: var(--transition);
    text-align: center;
    text-decoration: none;
    display: block;
}

.whatsapp-btn:hover {
    background-color: #128C7E;
    transform: translateY(-2px);
}

.close-btn {
    background-color: #f8f9fa;
    color: var(--dark-text);
    border: 1px solid #e1e5eb;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: var(--transition);
}

.close-btn:hover {
    background-color: #e9ecef;
}

/* Adaptación para móviles */
@media (max-width: 576px) {
    .help-button {
        top: 15px;
        right: 15px;
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .modal-content {
        width: 85%;
        padding: 20px;
    }
}
    </style>
</head>
<body>
    <div class="container fade-in">

        <!-- Botón de ayuda "¿Cómo participar?" -->
<button id="help-button" class="help-button">¿Cómo participar?</button>


        <div class="logo">
             <img src="logograndeponlenombrealaapp.jpg" alt="Logo VotApp" class="logo-img">
            <div class="logo-subtitle">¡Sistema de Votación para la App del Gerente!</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-circle"></div>
            <p>Cargando...</p>
        </div>
        
        <div id="login-form">
            <h1>Inicia tu Votación</h1>
            
            <div class="form-group">
                <label for="empleado">Número de Empleado</label>
                <input type="text" id="empleado" maxlength="6" placeholder="Ingresa máximo 6 dígitos">
                <div class="error" id="empleado-error"></div>
            </div>
            
            <div class="form-group">
                <label for="nombre">Nombre Completo</label>
                <input type="text" id="nombre" placeholder="Escribe tu nombre completo">
                <div class="error" id="nombre-error"></div>
            </div>
            
            <div class="form-group">
                <label for="tienda">Selecciona tu Tienda</label>
                <div class="autocomplete-container">
                    <input type="text" id="tienda-search" class="autocomplete-input" placeholder="Busca y selecciona una tienda" autocomplete="off">
                    <input type="hidden" id="tienda" value="">
                    <div id="tienda-options" class="autocomplete-items" style="display: none;"></div>
                </div>
                <div class="error" id="tienda-error"></div>
            </div>
            
            <button id="continuar">Continuar</button>
            <button id="ver-propuestas" class="secondary-btn">Ver propuestas actuales</button>
        </div>
        
        <div id="opciones-form" class="options">
            <h2>¿Qué deseas hacer?</h2>
            
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="opcion" value="proponer"> 
                    Proponer un nombre para la app
                </label>
                
                <label class="radio-option">
                    <input type="radio" name="opcion" value="votar"> 
                    Votar por un nombre existente
                </label>
            </div>
            
            <button id="seleccionar-opcion">Continuar</button>
        </div>
        
        <div id="proponer-form" class="options">
            <h2>Proponer un Nombre</h2>
            
            <div class="form-group">
                <label for="propuesta">Nombre para la App</label>
                <input type="text" id="propuesta" placeholder="Escribe tu propuesta de nombre">
                <div class="error" id="propuesta-error"></div>
            </div>
            
            <button id="enviar-propuesta">Enviar Propuesta</button>
            <div id="propuesta-success" class="success"></div>
        </div>
        
        <div id="votar-form" class="options">
            <h2>Votar por un Nombre</h2>
            
            <div id="nombres-list" class="nombres-list">
                <!-- Aquí se mostrarán los nombres propuestos dinámicamente -->
            </div>
            
            <button id="enviar-voto">Enviar Voto</button>
            <div id="voto-success" class="success"></div>
        </div>
    
        <div id="consulta-propuestas" class="options">
            <h2>Propuestas Actuales</h2>
            
            <div id="propuestas-consulta" class="nombres-list">
                <!-- Aquí se mostrarán las propuestas -->
            </div>
            
            <div id="no-propuestas-msg" style="display: none; text-align: center; margin: 20px 0;">
                <p>No hay propuestas registradas actualmente.</p>
            </div>
            
            <button id="volver-inicio" class="secondary-btn">Volver al inicio</button>
        </div>
    
    </div>

    <!-- Incluir Firebase (Versión modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, runTransaction, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAFMp3BbMM-indcX7FWlrTFFoEX4vG-Kt8",
            authDomain: "sistemavotaciones-b0bba.firebaseapp.com",
            projectId: "sistemavotaciones-b0bba",
            storageBucket: "sistemavotaciones-b0bba.firebasestorage.app",
            messagingSenderId: "203898236463",
            appId: "1:203898236463:web:18a14b0b282cc43544e0da"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Exponer funciones de Firebase al ámbito global para poder usarlas
        window.firebaseModules = {
            db,
            collection,
            addDoc,
            getDocs,
            doc,
            getDoc,
            updateDoc,
            runTransaction,
            query,
            where,
            orderBy,
            serverTimestamp
        };
    </script>

    <script>
        // Esperar a que el DOM y Firebase estén listos
        document.addEventListener('DOMContentLoaded', () => {
            // Esperar a que los módulos de Firebase estén disponibles
            setTimeout(inicializarApp, 500);
        });

        function inicializarApp() {
            // Obtener los módulos de Firebase
            const { 
                db, 
                collection, 
                addDoc, 
                getDocs, 
                doc,
                getDoc, 
                updateDoc, 
                runTransaction, 
                query, 
                where, 
                orderBy, 
                serverTimestamp 
            } = window.firebaseModules || {};
            
            // Verificar que Firebase esté cargado
            if (!db) {
                console.error("Firebase no se ha cargado correctamente.");
                alert("Error al cargar la base de datos. Por favor, recarga la página.");
                return;
            }
            
            console.log("Firebase inicializado correctamente");
            
            // Elementos DOM
            const loginForm = document.getElementById('login-form');
            const opcionesForm = document.getElementById('opciones-form');
            const proponerForm = document.getElementById('proponer-form');
            const votarForm = document.getElementById('votar-form');
            const progressBar = document.getElementById('progress');
            const loading = document.getElementById('loading');
            
            // Botones
            const continuarBtn = document.getElementById('continuar');
            const seleccionarOpcionBtn = document.getElementById('seleccionar-opcion');
            const enviarPropuestaBtn = document.getElementById('enviar-propuesta');
            const enviarVotoBtn = document.getElementById('enviar-voto');
            
            // Campos
            const empleadoInput = document.getElementById('empleado');
            const nombreInput = document.getElementById('nombre');
            const tiendaSelect = document.getElementById('tienda');
            const propuestaInput = document.getElementById('propuesta');
            
            // Errores
            const empleadoError = document.getElementById('empleado-error');
            const nombreError = document.getElementById('nombre-error');
            const tiendaError = document.getElementById('tienda-error');
            const propuestaError = document.getElementById('propuesta-error');
            
            // Mensajes de éxito
            const propuestaSuccess = document.getElementById('propuesta-success');
            const votoSuccess = document.getElementById('voto-success');
            
            // Variables globales
            let propuestas = [];
            let empleadoActual = '';


            // Cadena de tiendas
            const cadenaTiendas = "B004 BIF APTO CHIHUAHUA|B005 BIF JUVENTUD|B013 BIF ROSITA|M001 CM MEXICALI CARRANZA|M004 CM ROSARITO|M005 CM TIJUANA MADERO|M006 CM TIJUANA ABASTOS|M007 CM TIJUANA BELLAS ARTE|M008 CM TIJUANA MATAMOROS|M009 CM LOS CABOS|M010 CM LA PAZ|M011 CM CAMARGO|M012 CM CASAS GRANDES|M013 CH DEGOLLADO|M014 CH INSURGENTES CENTRO|M015 CH JILOTEPEC|M017 CM ABASTOS|M018 CM CHIHUAHUA 2000|M019 CM BOMBERO|M020 CM JUAN ESCUTIA|M021 CM MEGA INDEPENDENCIA|M025 CM NUEVA ESPAÑA|M026 CM AMERICAS|M029 CM FRANCISCO PORTILLO|M030 CM ZARAGOZA|M031 CM ZARCO|M032 CM CUAUHTEMOC CENTRO|M033 CM BASICA DELICIAS|M035 CM PARRAL|M036 CM JIMENEZ|M037 CM OJINAGA|M038 CM ACUÑA|M039 CM CHAVEZ|M040 CM MONCLOVA|M042 CM SALTILLO CENTRO|M043 CM SAN PEDRO|M044 CM ALIANZA|M045 CM TORREON 2|M047 CM MEGA TORREON|M048 CM TORREON|M049 CM PIEDRAS NEGRAS|M051 CM DURANGO ABASTOS|M052 CM DURANGO HEROICO|M053 CM DURANGO EXCUARTELE|M054 CM GOMEZ MADERO|M055 CM MEGA MINA|M056 CM LERDO|M058 CM DURANGO BOULEVARD|M059 CM CULIACAN ABASTOS|M060 CM BARRANCOS|M061 CM SANALONA|M062 CM TIERRA BLANCA|M063 CM GUAMUCHIL|M064 CM GUASAVE|M065 CM LA YARDA|M066 CM RAFAEL BUELNA|M067 CM AGUAPRIETA|M068 CM CABORCA|M069 CM GUAYMAS|M070 CM HERMOSILLO|M071 CM HERMOSILLO MADERO|M072 CM MEGA HERMOSILLO|M073 CM PALO VERDE|M074 CM NAVOJOA|M075 CM NOGALES|M076 CM CALIFORNIA|M077 CM JALISCO|M078 CM C.DE LA CARNE MDO|M079 CM TECATE|M080 CM SAN LUIS RIO COLORADO|M081 CM GUADALUPE ZACATECAS|M083 CM ZACATECAS|M084 CM CUCAPAH|M085 CM PUEBLO NUEVO|M086 CM MONTERREY SENDERO|M088 CM HERMOSILLO PERISUR|M089 CM LOS MOCHIS AHOME|M090 CM REYNOSA|M091 CM MATAMOROS|M092 CM RIO BRAVO|M093 CM NUEVO LAREDO|M095 CM ESTRELLA|M101 CM SAN MIGUEL DE ALLEND|M102 CM HUATABAMPO|M103 CM TORRELANDA|M104 CM VALTIERRA|M105 CM GUANAJUATO|M106 CM ZACATECAS DOS VIAS|M107 CM ARAMBERRI|M108 CM REYNOSA CENTRO|M109 CM NAVOLATO|M110 CM SAN JOSE DEL CABO|M111 CM GABRIEL LEYVA|M113 CM IRAPUATO|M114 CM SAN LUIS POTOSI CEN|M115 CM LINARES|M120 CM MATAMOROS LAG|M121 CM HEROES DE CAÑONERO|M122 CM CD VICTORIA|M123 CM MANTE|M124 CM CD VALLES|M125 CM MEOQUI|M126 CM VILLA DE ALVAREZ|M127 CM ALTAMIRA|M128 CM EMPALME|M129 CM MADERO|M130 CM GUERRERO|M133 CM SAN FERNANDO|M134 CM MANZANILLO|M135 CM SANTIAGO PAPASQUIARO|M138 CM CORDOBA|M139 CM PUERTO VALLARTA|M140 CM SLP ANAYA|M141 CM AVICOLA|M143 CM NUEVO LAREDO SAMANO|M144 CM RIO GRANDE ZACATECAS|M146 CM COLIMA 2|M147 CM MATEHUALA|M148 CM TEPIC|M149 CM POZA RICA|M150 CM DIAZ MIRON|M151 CM DOMINGO DIEZ|M152 CM TUXPAN|M153 CM CUAUTLA|M154 CM ORIZABA|M155 CM MATAMOROS BLV|M156 CM LOPEZ PORTILLO|M157 CM YAUTEPEC|M158 CM FRONTERA|M159 CM NOGALES GRECO|M161 CM ENSENADA CENTRO|M162 CM REYNOSA LOMAS|M165 CM GUZMAN|M166 CM TEMIXCO|M167 CM MATAMOROS COLISEO|M168 CM TECOMAN|M169 CM RIO VERDE|M170 CM NUEVO LAREDO TECNOLOGICO|M171 CM KABAH|M172 CM OBREGON MISIONES|M173 CM PLAYA DEL CARMEN|M174 CM CANCUN LOPEZ PORTILLO|M176 CM FLORES MAGON|M177 CM PLANTA|M178 CM MARTINEZ DE LA TORRE|M184 CM SABINAS|M185 CM NICHUPTE|M186 CM PACHUCA|M187 CM TIERRA PROPIA|M188 CH TORRES DEL SUR|M189 CM LA PAZ COLOSIO|M190 CM TEPIC CENTRO|M191 CM MONCLOVA SAN JOSE|M195 CM LAS TORRES|M197 CM MERIDA CANEK|M199 CM ACUÑA II LIBRAMIENTO|M200 CM REYNOSA 20 DE NOVIEMBRE|M204 CM MESTIZA|M206 CM SANTIAGO|M209 CM TIJUANA LAZARO CARDENAS|M210 CM TIJUANA DIAZ ORDAZ|M211 CM MOCHIS CENTRO|M212 CM CULIACAN CLOUTHIER|M213 CM COATZACOALCOS MIGUEL HIDALG|M214 CM MINATITLAN LERDO|M216 CM SAN LUIS CAMPESTRE|M217 CM MEXICALI VALLE DE PUEBLA|M218 CM GUILLERMO PRIETO|M220 CM SAN FCO DEL RINCON|M221 CM CD VICTORIA CENTRO|M222 CM SILAO|M223 CM POZA RICA CARDENAS|M224 CM CUERNAVACA 2|M225 CM CELAYA IRRIGACION|M226 CM MAGDALENA DE KINO|M228 CM TULANCINGO|M229 CM CHILPANCINGO|M230 CM ACAPULCO PIE DE CUESTA|M231 CM CAMPO BELLO|M233 CM VILLAHERMOSA PINO SUAREZ|M234 CM ACAPULCO UNIVERSIDAD|M235 CM ACAPULCO VALLARTA|M236 CM SAN LUIS POTOSI SALK|M237 CM SAHUAYO|M240 CM VILLAHERMOSA USUMACINTA|M241 CM DURANGO FACTOR|M242 CM ACAPULCO DIAMANTE|M243 CH EJERCITO NACIONAL|M244 CH AERONAUTICA|M245 CH TRONCOSO|M246 CH LIBRAMIENTO|M247 CH GOMEZ MORIN|M250 CH CENTRO|M251 CH TECNOLOGICO|M252 CH BUFALO|M254 CH PUERTO PALOS|M255 CM CONDESA|M256 CM PLAYA DE CARMEN COLOSIO|M259 CM COZUMEL|M260 CM CANCUN UXMAN|M261 CM BUGAMBILIAS|M262 CM LOS TULES|M263 CM RANCHO VIEJO|M264 CM MAZATLAN MUNICH|M265 CM CELAYA SAN JOSE|M266 CM CONSTITUCION|M267 CM PROGRESO|M268 CH CARLOS AMAYA|M269 CH 16 DE SEPTIEMBRE|M270 CM FIDEL VELAZQUEZ|M273 CM NAVOJOA LAZARO CARDENAS|M274 CM NOGALES MAESTROS|M276 CM CURVA TEXAS|M277 CM LOLA BELTRAN|M278 CM PACHUCA TULIPANES|M279 CM QUERETARO LAS FUENTES|M281 CM TAMPICO ALTAMA|M283 CM CAMPECHE JAINA|M284 CM COMALCALCO|M285 CM MERCADO TAMULTE|M286 CM QUERETARO BELEM|M287 CM ACAPULCO CAYACO|M290 CM ESCUINAPA|M291 CM TULUM|M292 CM ZIHUATANEJO|M293 CM CARDENAS TABASCO|M294 LP PUEBLA CARRANZA|M297 CM GUSTAVO A. MADERO|M298 CM PLAN DE AYALA|M300 CM PANTITLAN|M301 CM PALENQUE CHIAPAS|M302 CM TUXTLA MERCADO DE ANCIANOS|M305 CM MORELIA CENTRO|M306 CM URUAPAN|M307 CM LA PIEDAD|M308 CM TUXTLA 5TA NORTE|M309 CM MORELIA TORREON|M310 CM PLAN DE SAN LUIS EJE 3|M311 CM ZAMORA|M313 CM CANANEA|M314 CM SAN JUAN DEL RIO|M315 CM PUERTO PEÑASCO|M316 CM FRESNILLO CENTRO|M317 CH MESA CENTRAL|M318 CM MIGUEL ALEMAN|M319 CM HERMOSILLO QUIROGA|M320 CM JEREZ CENTRO|M321 CM LEONA LOS CABOS|M322 CM SAN JOSE DEL CABO FORJADOR|M323 CH OASIS|M324 CM PANUCO|M326 CM VICTORIA ZEFERINO|M327 LP PUEBLA 16 DE SEPIEM|M331 LP STA ANA TLAXCALA|M332 CM SALAMANCA VALLE DE SANTIAGO|M333 LP XALAPA|M334 CM CHETUMAL|M339 CM QUERETARO REVOLUCION|M340 CM PLAYA VILLAS DEL SOL|M341 CM MACUSPANA|M342 CM TUXTLA TERAN|M345 CM IRAPUATO REFORMA|M347 LP CAMINO REAL|M348 CM CANCUN TALLERES|M352 CM JARDINES DE MORELOS|M354 CM LEON ANTONIO MADRAZO|M355 CM CD DEL CARMEN|M356 LP IZUCAR|M361 CM IGUALA GUERRERO|M362 CM SAN LUIS POTOSI SAUCITO|M363 CM SAN CRISTOBAL DE LAS CASAS|M364 CM VALLADOLID YUCATAN|M366 CM ZITACUARO|M370 CM PACHUCA MADERO|M371 CM VILLAHERMOSA CD. INDUSTRIA|M374 CM LAGOS DE MORENO|M377 CM CHETUMAL CENTRO|M378 LP APIZACO|M382 CM QUERETARO ZARAGOZA|M384 LP ZAPATA|M385 LP 11 SUR|M386 LP CENTRO ATLIXCO|M387 LP BALCONES|M388 LP CHAPULTEPEC|M389 LP CHOLULA|M390 LP MOMOXPAN|M391 LP XILOTZINGO|M394 LP SAN MARTIN TEXM.|M395 LP C. DISTRIB. MIREYA|M396 LP C. DISTRIB. CEDRO|M397 LP PALMAS|M398 LP CAPU|M399 LP DISTR. LACTEOS|M401 LP EL PATO IZTAPALAPA|M402 LP LA CENTRAL IZTAPALA|M414 LP TEZIUTLAN|M415 LP CLAVIJERO|M416 LP TEHUACAN|M417 LP 31 PONIENTE|M418 LP AMOZOC|M419 LP 5 DE MAYO|M420 LP MERCADO MORALE|M421 CH MEZQUITAL|M422 CM TIJUANA TEC|M423 CM VERACRUZ ASTILLEROS|M425 CM PTO LAZARO CARDENAS|M427 CM HERMOSILLO CENTRO|M428 CM MOCHIS LAS CAÑAS|M429 CM EL SALTO DURANGO|M430 CM ACAPULCO RENACIMIENTO|M431 CM MAZATLAN CENTRO|M432 CM CULIACAN MADERO|M437 CM DURANGO MERCADO REFUGIO|M439 CH TALAMAS|M441 LP ATLIXCO ROTONDA|M442 LP SAN MARTIN AVILA|M443 LP LOMAS DE ANGELOPOLI|M444 LP MERCADO ACOCOTA|M445 LP TECAMACHALCO|M446 LP PLAZA PIRULES|M448 LP TEPEACA CUAUHTEMOC|M449 LP ZACATLAN|M450 LP HUAMANTLA|M451 CM LA PAZ CAMINO REAL|M452 LP TLAXCALA MIGUEL HIDALGO|M453 LP ACAJETE|M454 LP CHALCO VICENTE GUERRERO|M455 LP CD. SERDAN|M456 LP CHALCO DEL MAZO|M457 LP CHALCO HEROES|M458 LP ACATZINGO|M459 LP PUEBLA LA MARIA|M460 LP HUAUCHINANGO|M461 LP JOJUTLA|M462 LP ZACAPOAXTLA|M463 LP MARGARITAS|M464 LP COATEPEC|M465 LP PEROTE|M466 LP CUAUTLANCINGO|M467 CM LEÓN OMEGA|M469 CMT TAPACHULA CAFETALERO|M470 LP ZACATELCO|M471 LP SANTA ANA CHIAUTEMPAN|M472 LP CHALCO EMILIANO ZAPATA|M474 LP CALPULALPAN|M475 LP CHIGNAHUAPAN|M476 LP GRAJALES|M480 CM LEON ESCOBEDO|M481 CM LEON DELTA|M482 CM LEON CAÑAVERAL|M489 CM PLAYA DEL CARMEN EJIDAL|M494 CM TEAPA|M495 CM VILLAHERMOSA POMOCA|M510 LP TEHUACAN LOPEZ MATEOS|M511 LP XICOTEPEC|M518 LP CD MENDOZA|M533 CM DELICIAS FERNANDO BAEZA|M534 CM PARRAL SUR|M542 CM PLAYA DEL CARMEN JUÁREZ|M547 CM PARAISO CENTRO";

                            // Función para cargar las tiendas dinámicamente
                            function cargarTiendas() {
                                const searchInput = document.getElementById('tienda-search');
                                const optionsContainer = document.getElementById('tienda-options');
                                const tiendaInput = document.getElementById('tienda');
                                
                                // Separar la cadena por el delimitador "|"
                                const tiendas = cadenaTiendas.split('|').map(t => t.trim());
                                
                                // Ordenar alfabéticamente
                                tiendas.sort();
                                
                                // Variable para controlar la navegación con teclado
                                let focusedIndex = -1;
                                
                                // Función para mostrar opciones filtradas
                                function mostrarOpciones(filtro) {
                                    // Limpiar opciones anteriores
                                    optionsContainer.innerHTML = '';
                                    focusedIndex = -1;
                                    
                                    if (!filtro) {
                                        // Si no hay filtro, mostrar las primeras 15 tiendas
                                        mostrarListado(tiendas.slice(0, 15), '');
                                        return;
                                    }
                                    
                                    // Convertir a minúsculas para comparación no sensible a mayúsculas
                                    const filtroLower = filtro.toLowerCase();
                                    
                                    // Filtrar tiendas que contengan el texto de búsqueda
                                    const tiendasFiltradas = tiendas.filter(tienda => 
                                        tienda.toLowerCase().includes(filtroLower)
                                    );
                                    
                                    // Limitar a máximo 15 resultados para mejor rendimiento
                                    const resultados = tiendasFiltradas.slice(0, 15);
                                    
                                    if (resultados.length === 0) {
                                        // Mostrar mensaje si no hay coincidencias
                                        optionsContainer.innerHTML = '<div class="autocomplete-item">No se encontraron tiendas</div>';
                                    } else {
                                        // Mostrar las coincidencias
                                        mostrarListado(resultados, filtroLower);
                                    }
                                }
                                
                                // Función para mostrar el listado con texto resaltado
                                function mostrarListado(lista, filtro) {
                                    lista.forEach(tienda => {
                                        const div = document.createElement('div');
                                        div.className = 'autocomplete-item';
                                        
                                        // Si hay un filtro, resaltar la parte coincidente
                                        if (filtro && filtro.length > 0) {
                                            const index = tienda.toLowerCase().indexOf(filtro.toLowerCase());
                                            if (index >= 0) {
                                                const antes = tienda.substring(0, index);
                                                const coincidencia = tienda.substring(index, index + filtro.length);
                                                const despues = tienda.substring(index + filtro.length);
                                                div.innerHTML = antes + '<span class="highlight">' + coincidencia + '</span>' + despues;
                                            } else {
                                                div.textContent = tienda;
                                            }
                                        } else {
                                            div.textContent = tienda;
                                        }
                                        
                                        // Evento para seleccionar una tienda
                                        div.addEventListener('click', function() {
                                            searchInput.value = tienda;
                                            tiendaInput.value = tienda; // Guardar en el input oculto
                                            optionsContainer.style.display = 'none';
                                        });
                                        
                                        optionsContainer.appendChild(div);
                                    });
                                    
                                    // Mostrar el contenedor de opciones
                                    if (lista.length > 0) {
                                        optionsContainer.style.display = 'block';
                                    } else {
                                        optionsContainer.style.display = 'none';
                                    }
                                }
                                
                                // Evento al escribir en el campo de búsqueda
                                searchInput.addEventListener('input', function() {
                                    const filtro = this.value.trim();
                                    mostrarOpciones(filtro);
                                });
                                
                                // Evento al enfocar el campo
                                searchInput.addEventListener('focus', function() {
                                    // Si no hay texto, mostrar las primeras opciones
                                    if (this.value.trim() === '') {
                                        mostrarOpciones('');
                                    } else {
                                        // Si ya hay texto, filtrar basado en ese texto
                                        mostrarOpciones(this.value.trim());
                                    }
                                });
                                
                                // Navegación con teclado
                                searchInput.addEventListener('keydown', function(e) {
                                    const items = optionsContainer.querySelectorAll('.autocomplete-item');
                                    
                                    // Tecla abajo
                                    if (e.key === 'ArrowDown') {
                                        e.preventDefault();
                                        
                                        // Mostrar opciones si están ocultas
                                        if (optionsContainer.style.display === 'none') {
                                            mostrarOpciones(this.value.trim());
                                            return;
                                        }
                                        
                                        focusedIndex = Math.min(focusedIndex + 1, items.length - 1);
                                        actualizarSeleccion(items);
                                    } 
                                    // Tecla arriba
                                    else if (e.key === 'ArrowUp') {
                                        e.preventDefault();
                                        focusedIndex = Math.max(focusedIndex - 1, 0);
                                        actualizarSeleccion(items);
                                    } 
                                    // Tecla Enter
                                    else if (e.key === 'Enter' && focusedIndex >= 0) {
                                        e.preventDefault();
                                        if (items[focusedIndex]) {
                                            items[focusedIndex].click();
                                        }
                                    }
                                    // Tecla Escape
                                    else if (e.key === 'Escape') {
                                        optionsContainer.style.display = 'none';
                                    }
                                });
                                
                                // Actualizar el elemento seleccionado visualmente
                                function actualizarSeleccion(items) {
                                    items.forEach((item, index) => {
                                        if (index === focusedIndex) {
                                            item.classList.add('selected');
                                            // Hacer scroll para que el elemento sea visible
                                            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                        } else {
                                            item.classList.remove('selected');
                                        }
                                    });
                                }
                                
                                // Cerrar opciones al hacer clic fuera
                                document.addEventListener('click', function(e) {
                                    if (!searchInput.contains(e.target) && !optionsContainer.contains(e.target)) {
                                        optionsContainer.style.display = 'none';
                                    }
                                });
                            }

                            // Llamar a la función para cargar las tiendas
                            cargarTiendas();
            
            // Eventos
            continuarBtn.addEventListener('click', validarLogin);
            seleccionarOpcionBtn.addEventListener('click', procesarOpcion);
            enviarPropuestaBtn.addEventListener('click', guardarPropuesta);
            enviarVotoBtn.addEventListener('click', guardarVoto);


            // Elementos DOM adicionales
                const verPropuestasBtn = document.getElementById('ver-propuestas');
                const consultaPropuestasDiv = document.getElementById('consulta-propuestas');
                const propuestasConsulta = document.getElementById('propuestas-consulta');
                const noPropuestasMsg = document.getElementById('no-propuestas-msg');
                const volverInicioBtn = document.getElementById('volver-inicio');

                // Eventos adicionales
                verPropuestasBtn.addEventListener('click', mostrarConsultaPropuestas);
                volverInicioBtn.addEventListener('click', volverAlInicio);

                // Funciones para consulta de propuestas
                function mostrarConsultaPropuestas() {
                    mostrarCargando(true);
                    
                    // Cargar propuestas desde Firestore
                    const propuestasRef = collection(db, 'propuestas');
                    const q = query(propuestasRef, orderBy('votos', 'desc'));
                    
                    getDocs(q)
                        .then((snapshot) => {
                            // Ocultar formulario de login
                            loginForm.style.display = "none";
                            
                            // Preparar contenedor de propuestas
                            propuestasConsulta.innerHTML = "";
                            
                            if (snapshot.empty) {
                                // Mostrar mensaje de que no hay propuestas
                                noPropuestasMsg.style.display = "block";
                                propuestasConsulta.style.display = "none";
                                mostrarCargando(false);
                            } else {
                                // Ocultar mensaje de no propuestas
                                noPropuestasMsg.style.display = "none";
                                propuestasConsulta.style.display = "block";
                                
                                // Crear elementos para cada propuesta sin tooltips individuales
                                snapshot.forEach((doc) => {
                                    const propuesta = {
                                        id: doc.id,
                                        ...doc.data()
                                    };
                                    
                                    const propuestaElement = document.createElement('div');
                                    propuestaElement.className = 'nombre-item';
                                    
                                    propuestaElement.innerHTML = `
                                        <div class="nombre-info">
                                            <strong>${propuesta.nombre}</strong>
                                            <span class="votos" data-propuesta="${propuesta.id}">${propuesta.votos} votos</span>
                                        </div>
                                    `;
                                    propuestasConsulta.appendChild(propuestaElement);
                                });
                                
                                // Mostrar la sección de consulta
                                mostrarCargando(false);
                                consultaPropuestasDiv.style.display = "block";
                                consultaPropuestasDiv.classList.add('fade-in');
                                
                                // Agregar eventos de clic a los botones de votos
                                document.querySelectorAll('#propuestas-consulta .votos').forEach(elemento => {
                                    elemento.addEventListener('click', toggleTooltip);
                                });
                            }
                        })
                        .catch((error) => {
                            mostrarCargando(false);
                            console.error("Error al cargar propuestas:", error);
                            alert("Error al cargar las propuestas. Intenta nuevamente.");
                        });
                }


                function volverAlInicio() {
                    // Ocultar consulta de propuestas
                    consultaPropuestasDiv.style.display = "none";
                    
                    // Mostrar formulario de login
                    loginForm.style.display = "block";
                    loginForm.classList.add('fade-in');
                }
            
            // Funciones
            function mostrarCargando(mostrar = true) {
                loading.style.display = mostrar ? 'block' : 'none';
            }
            
            function validarLogin() {
                let esValido = true;
                
                // Validar empleado (solo números, máximo 6 dígitos)
                const empleadoRegex = /^\d{1,6}$/;
                if (!empleadoRegex.test(empleadoInput.value)) {
                    empleadoError.textContent = "Ingresa un número de empleado válido (hasta 6 dígitos)";
                    esValido = false;
                } else {
                    empleadoError.textContent = "";
                }
                
                // Validar nombre
                if (nombreInput.value.trim() === "") {
                    nombreError.textContent = "El nombre es requerido";
                    esValido = false;
                } else {
                    nombreError.textContent = "";
                }
                
                 // Validar tienda
                const tiendaValue = document.getElementById('tienda').value;
                if (tiendaValue === "") {
                    tiendaError.textContent = "Selecciona una tienda";
                    esValido = false;
                } else {
                    tiendaError.textContent = "";
                }
                                
               // Dentro de la función validarLogin(), reemplaza este bloque:
                if (esValido) {
                    // Guardar el ID del empleado actual
                    empleadoActual = empleadoInput.value;
                    
                    // Verificar si el empleado ya votó
                    mostrarCargando(true);
                    
                    const votosRef = collection(db, 'votos');
                    const q = query(votosRef, where('empleadoId', '==', empleadoActual));
                    
                    getDocs(q)
                        .then((snapshot) => {
                            mostrarCargando(false);
                            
                            if (!snapshot.empty) {
                                alert("Ya has emitido un voto anteriormente.");
                                return;
                            }
                            
                            // Ocultar login y mostrar opciones
                            loginForm.style.display = "none";
                            opcionesForm.style.display = "block";
                            
                            // Actualizar barra de progreso
                            progressBar.style.width = "66%";
                            
                            // Animación
                            opcionesForm.classList.add('fade-in');
                        })
                        .catch((error) => {
                            mostrarCargando(false);
                            console.error("Error al verificar voto:", error);
                            alert("Error al verificar si ya has votado. Intenta nuevamente.");
                        });
                }
            }
            
            function procesarOpcion() {
                    const opcionSeleccionada = document.querySelector('input[name="opcion"]:checked');
                    
                    if (!opcionSeleccionada) {
                        alert("Por favor, selecciona una opción");
                        return;
                    }
                    
                    opcionesForm.style.display = "none";
                    progressBar.style.width = "100%";
                    
                    if (opcionSeleccionada.value === "proponer") {
                        proponerForm.style.display = "block";
                        proponerForm.classList.add('fade-in');
                    } else {
                        mostrarCargando(true);
                        
                        // Cargar propuestas desde Firestore
                        const propuestasRef = collection(db, 'propuestas');
                        const q = query(propuestasRef, orderBy('votos', 'desc'));
                        
                        getDocs(q)
                            .then((snapshot) => {
                                propuestas = [];
                                
                                if (snapshot.empty) {
                                    mostrarCargando(false);
                                    alert("No hay propuestas disponibles para votar. Por favor propón un nombre primero.");
                                    // Volver a las opciones
                                    opcionesForm.style.display = "block";
                                    progressBar.style.width = "66%";
                                    return;
                                }
                                
                                snapshot.forEach((doc) => {
                                    propuestas.push({
                                        id: doc.id,
                                        ...doc.data()
                                    });
                                });
                                
                                cargarPropuestas();
                                mostrarCargando(false);
                                votarForm.style.display = "block";
                                votarForm.classList.add('fade-in');
                            })
                            .catch((error) => {
                                mostrarCargando(false);
                                console.error("Error al cargar propuestas:", error);
                                alert("Error al cargar las propuestas. Intenta nuevamente.");
                            });
                    }
                }
            
              
                function cargarPropuestas() {
                    const nombresList = document.getElementById('nombres-list');
                    nombresList.innerHTML = "";
                    
                    if (propuestas.length === 0) {
                        nombresList.innerHTML = "<p>No hay propuestas disponibles aún. ¡Sé el primero en proponer un nombre!</p>";
                        return;
                    }
                    
                    // Para cada propuesta, generamos el elemento en la lista
                    mostrarCargando(true);
                    
                    // Crear elementos para cada propuesta sin tooltips individuales
                    propuestas.forEach(propuesta => {
                        const propuestaElement = document.createElement('div');
                        propuestaElement.className = 'nombre-item';
                        
                        propuestaElement.innerHTML = `
                            <input type="radio" name="propuesta-voto" value="${propuesta.id}" id="prop-${propuesta.id}">
                            <div class="nombre-info">
                                <label for="prop-${propuesta.id}"><strong>${propuesta.nombre}</strong></label>
                                <span class="votos" data-propuesta="${propuesta.id}">${propuesta.votos} votos</span>
                            </div>
                        `;
                        nombresList.appendChild(propuestaElement);
                    });
                    
                    mostrarCargando(false);
                    
                    // Agregar eventos de clic a los botones de votos
                    document.querySelectorAll('#nombres-list .votos').forEach(elemento => {
                        elemento.addEventListener('click', toggleTooltip);
                    });
}
            
            function guardarPropuesta() {
                const nuevaPropuesta = propuestaInput.value.trim();
                
                if (nuevaPropuesta === "") {
                    propuestaError.textContent = "Ingresa un nombre para la propuesta";
                    return;
                }
                
                mostrarCargando(true);
                enviarPropuestaBtn.disabled = true;
                
                // Verificar si ya existe la propuesta
                const propuestasRef = collection(db, 'propuestas');
                const q = query(propuestasRef, where('nombre', '==', nuevaPropuesta));
                
                getDocs(q)
                    .then((snapshot) => {
                        if (!snapshot.empty) {
                            mostrarCargando(false);
                            propuestaError.textContent = "Esta propuesta ya existe";
                            enviarPropuestaBtn.disabled = false;
                            return;
                        }
                        
                        // Crear nueva propuesta en Firestore
                        addDoc(propuestasRef, {
                            nombre: nuevaPropuesta,
                            votos: 1,
                            fechaCreacion: serverTimestamp()
                        })
                        .then((docRef) => {
                            // Registrar el voto del empleado
                            const votosRef = collection(db, 'votos');
                            return addDoc(votosRef, {
                                empleadoId: empleadoActual,
                                nombre: nombreInput.value.trim(),
                                tienda: tiendaSelect.value,
                                propuestaId: docRef.id,
                                propuestaNombre: nuevaPropuesta,
                                fechaVoto: serverTimestamp()
                            });
                        })
                        .then(() => {
                            mostrarCargando(false);
                            propuestaInput.value = "";
                            propuestaError.textContent = "";
                            propuestaSuccess.textContent = "¡Tu propuesta ha sido guardada y se registró tu voto!";
                            
                            // Después de 3 segundos, regresar al inicio
                            setTimeout(() => {
                                reiniciarFormulario();
                            }, 3000);
                        })
                        .catch((error) => {
                            mostrarCargando(false);
                            enviarPropuestaBtn.disabled = false;
                            console.error("Error al guardar propuesta:", error);
                            alert("Error al guardar la propuesta. Intenta nuevamente.");
                        });
                    })
                    .catch((error) => {
                        mostrarCargando(false);
                        enviarPropuestaBtn.disabled = false;
                        console.error("Error al verificar propuesta existente:", error);
                        alert("Error al verificar propuestas existentes. Intenta nuevamente.");
                    });
            }
            
            function guardarVoto() {
                const propuestaSeleccionada = document.querySelector('input[name="propuesta-voto"]:checked');
                
                if (!propuestaSeleccionada) {
                    alert("Por favor, selecciona una propuesta para votar");
                    return;
                }
                
                mostrarCargando(true);
                enviarVotoBtn.disabled = true;
                
                const propuestaId = propuestaSeleccionada.value;
                const propuestaIndex = propuestas.findIndex(p => p.id === propuestaId);
                const propuestaNombre = propuestas[propuestaIndex].nombre;
                
                // Incrementar el contador de votos en Firestore (transacción)
                const propuestaRef = doc(db, 'propuestas', propuestaId);
                
                runTransaction(db, async (transaction) => {
                    const propuestaDoc = await transaction.get(propuestaRef);
                    
                    if (!propuestaDoc.exists()) {
                        throw "La propuesta no existe";
                    }
                    
                    const nuevoVotos = propuestaDoc.data().votos + 1;
                    transaction.update(propuestaRef, { votos: nuevoVotos });
                })
                .then(() => {
                    // Registrar el voto del empleado
                    const votosRef = collection(db, 'votos');
                    return addDoc(votosRef, {
                        empleadoId: empleadoActual,
                        nombre: nombreInput.value.trim(),
                        tienda: tiendaSelect.value,
                        propuestaId: propuestaId,
                        propuestaNombre: propuestaNombre,
                        fechaVoto: serverTimestamp()
                    });
                })
                .then(() => {
                    // Actualizar la interfaz
                    propuestas[propuestaIndex].votos++;
                    mostrarCargando(false);
                    votoSuccess.textContent = "¡Tu voto ha sido registrado con éxito!";
                    cargarPropuestas();
                    
                    // Después de 3 segundos, regresar al inicio
                    setTimeout(() => {
                        reiniciarFormulario();
                    }, 3000);
                })
                .catch((error) => {
                    mostrarCargando(false);
                    enviarVotoBtn.disabled = false;
                    console.error("Error al registrar voto:", error);
                    alert("Error al registrar el voto. Intenta nuevamente.");
                });
            }


            // Función para obtener la información del proponente de una propuesta
                async function obtenerInfoProponente(propuestaId) {
                    try {
                        const votosRef = collection(db, 'votos');
                        const q = query(votosRef, where('propuestaId', '==', propuestaId));
                        const snapshot = await getDocs(q);
                        
                        // Buscar el primer voto para esta propuesta (debería ser el del proponente)
                        if (!snapshot.empty) {
                            const votoData = snapshot.docs[0].data();
                            return {
                                nombre: votoData.nombre || 'Anónimo',
                                tienda: votoData.tienda || 'No especificada',
                                fechaVoto: votoData.fechaVoto || null
                            };
                        }
                        
                        return null;
                    } catch (error) {
                        console.error("Error al obtener información del proponente:", error);
                        return null;
                    }
                }

                // Función para formatear fechas
                function formatearFecha(timestamp) {
                    if (!timestamp) return 'Fecha desconocida';
                    
                    const fecha = new Date(timestamp.seconds * 1000);
                    return fecha.toLocaleDateString('es-ES', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }



                // Variable global para controlar el estado del tooltip
                let tooltipActivo = null;

                // Función completamente rediseñada para mostrar/ocultar tooltip
                    function toggleTooltip(event) {
                        event.stopPropagation(); // Detener propagación del evento
                        
                        const propuestaId = this.getAttribute('data-propuesta');
                        const tooltipGlobal = document.getElementById('tooltip-global');
                        const tooltipContent = tooltipGlobal.querySelector('.tooltip-content');
                        
                        // Si el elemento actualmente activo es este mismo, solo ocultar
                        if (tooltipActivo === this) {
                            tooltipGlobal.style.display = 'none';
                            this.classList.remove('active');
                            tooltipActivo = null;
                            return;
                        }
                        
                        // Remover la clase active de cualquier otro botón
                        document.querySelectorAll('.votos.active').forEach(el => {
                            el.classList.remove('active');
                        });
                        
                        // Buscar la información del proponente
                        obtenerInfoProponente(propuestaId).then(info => {
                            if (!info) {
                                console.error('No se pudo obtener información del proponente');
                                return;
                            }
                            
                            // Actualizar contenido del tooltip
                            tooltipContent.innerHTML = `
                                Propuesto por: ${info.nombre}<br>
                                Tienda: ${info.tienda}<br>
                                Fecha: ${formatearFecha(info.fechaVoto)}
                            `;
                            
                            // Encontrar el elemento nombre-item padre
                            let nombreItem = this.closest('.nombre-item');
                            
                            // Posicionar tooltip en el centro del elemento nombre-item
                            const rect = nombreItem.getBoundingClientRect();
                            tooltipGlobal.style.left = (rect.left + rect.width/2) + 'px';
                            tooltipGlobal.style.top = (rect.top + rect.height/2 - 60) + 'px'; // Centrado verticalmente
                            tooltipGlobal.style.transform = 'translateX(-50%)';
                            
                            // Mostrar tooltip
                            tooltipGlobal.style.display = 'block';
                            
                            // Establecer este elemento como activo
                            this.classList.add('active');
                            tooltipActivo = this;
                        });
                    }
                                    

                // Cerrar tooltip al hacer clic en cualquier parte
                document.addEventListener('click', function(event) {
                    if (!event.target.classList.contains('votos')) {
                        const tooltipGlobal = document.getElementById('tooltip-global');
                        tooltipGlobal.style.display = 'none';
                        
                        document.querySelectorAll('.votos.active').forEach(voto => {
                            voto.classList.remove('active');
                        });
                        
                        tooltipActivo = null;
                    }
                });


                // Cerrar tooltip al hacer scroll
                window.addEventListener('scroll', function() {
                    const tooltipGlobal = document.getElementById('tooltip-global');
                    if (tooltipGlobal.style.display === 'block') {
                        tooltipGlobal.style.display = 'none';
                        
                        document.querySelectorAll('.votos.active').forEach(voto => {
                            voto.classList.remove('active');
                        });
                        
                        tooltipActivo = null;
                    }
                });

                // También cerrar al hacer scroll en los contenedores de propuestas
                document.getElementById('nombres-list').addEventListener('scroll', function() {
                    const tooltipGlobal = document.getElementById('tooltip-global');
                    tooltipGlobal.style.display = 'none';
                    
                    document.querySelectorAll('.votos.active').forEach(voto => {
                        voto.classList.remove('active');
                    });
                    
                    tooltipActivo = null;
                });

                document.getElementById('propuestas-consulta').addEventListener('scroll', function() {
                    const tooltipGlobal = document.getElementById('tooltip-global');
                    tooltipGlobal.style.display = 'none';
                    
                    document.querySelectorAll('.votos.active').forEach(voto => {
                        voto.classList.remove('active');
                    });
                    
                    tooltipActivo = null;
                });

            
            function reiniciarFormulario() {
                // Ocultar todos los formularios
                loginForm.style.display = "block";
                opcionesForm.style.display = "none";
                proponerForm.style.display = "none";
                votarForm.style.display = "none";
                consultaPropuestasDiv.style.display = "none";
                
                // Resetear barra de progreso
                progressBar.style.width = "33%";
                
                // Habilitar botones
                enviarPropuestaBtn.disabled = false;
                enviarVotoBtn.disabled = false;
                
                // Limpiar campos
                empleadoInput.value = "";
                nombreInput.value = "";
                tiendaSelect.value = "";
                propuestaInput.value = "";
                
                // Limpiar errores
                empleadoError.textContent = "";
                nombreError.textContent = "";
                tiendaError.textContent = "";
                propuestaError.textContent = "";
                
                // Limpiar mensajes de éxito
                propuestaSuccess.textContent = "";
                votoSuccess.textContent = "";
                
                // Añadir animación
                loginForm.classList.add('fade-in');



            }





            // Funcionalidad del modal de ayuda
                const helpButton = document.getElementById('help-button');
                const helpModal = document.getElementById('help-modal');

                helpButton.addEventListener('click', function() {
                    helpModal.style.display = 'block';
                });

                // Función para cerrar el modal
                window.cerrarModal = function() {
                    helpModal.style.display = 'none';
                };

                // Cerrar el modal si se hace clic fuera del contenido
                window.addEventListener('click', function(event) {
                    if (event.target === helpModal) {
                        helpModal.style.display = 'none';
                    }
                });

        }
    
    
    
    
    //
    </script>


<!-- Tooltip global para mostrar información de propuestas -->
<div id="tooltip-global" class="tooltip-global">
    <div class="tooltip-content"></div>
</div>
<!-- Modal de "¿Cómo participar?" -->
<div id="help-modal" class="modal">
    <div class="modal-content">
        <h2>¿Cómo participar en el concurso?</h2>
        <p>Ponle nombre a la app del gerente</p>
        <p>Ingresa tu número de colaborador, tu nombre completo y selecciona el nombre de tu tienda. Luego da clic en <strong>Continuar</strong>.</p>
        <ol>
            <li>Se te mostrarán dos opciones:
                <ul>
                    <li>Proponer un nombre para la app</li>
                    <li>Votar por un nombre existente</li>
                </ul>
            </li>
            <li>Si eliges <strong>proponer un nombre</strong>, solo escríbelo y da clic en <strong>Guardar</strong>.</li>
            <li>Si eliges <strong>votar por un nombre</strong>, podrás ver las propuestas de otros compañeros y seleccionar la que más te guste.</li>
        </ol>
        <p>Recuerda: solo puedes proponer un nombre y votar una sola vez.</p>
        <p>Gana el nombre que reciba más votos. En caso de empate, ganará el que haya alcanzado primero la puntuación ganadora.</p>
        <p>Si tienes dudas, ingresa al grupo de WhatsApp de la app del gerente haciendo clic aquí:</p>
        <div class="modal-buttons">
            <a href="https://chat.whatsapp.com/F73Xe1xJAdWDOOVs7XkljO" class="whatsapp-btn" target="_blank">Grupo de WhatsApp</a>
            <button class="close-btn" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>
</div>

</body>
</html>