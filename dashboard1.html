<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Votación App del Gerente</title>
    
    <!-- Estilos CSS -->
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56e8;
            --secondary-color: #7209b7;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --gray-text: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
            --card-bg: white;
            --success-color: #2a9d8f;
            --warning-color: #e9c46a;
            --danger-color: #e63946;
            --info-color: #4cc9f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            max-width: 120px;
            height: auto;
        }
        
        .title-container h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .title-container .subtitle {
            font-size: 0.9rem;
            color: var(--gray-text);
        }
        /* Estilos para los módulos */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Forzamos a que siempre haya 2 columnas */
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .module {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 10px;
        }
        
        .module-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .module-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Estilos para los stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-text);
            font-weight: 500;
        }
        
        /* Botones */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .btn-icon {
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Estilos para tablas */
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            max-height: 400px;  /* Altura máxima para mostrar aproximadamente 10 filas */
            overflow-y: auto;   /* Añade scroll vertical cuando sea necesario */
        }
                
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eef0f5;
        }
        
        th {
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        
        tbody tr {
            transition: var(--transition);
        }
        
        tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        /* Estilos para posiciones de ranking */
        .ranking {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .ranking-1 {
            background-color: gold;
            color: #333;
        }
        
        .ranking-2 {
            background-color: silver;
            color: #333;
        }
        
        .ranking-3 {
            background-color: #cd7f32; /* Bronze */
            color: white;
        }
        
        /* Estilos para modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 500px;
            padding: 25px;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eef0f5;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-text);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 5px;
            display: block;
        }
        
        .detail-value {
            color: var(--gray-text);
            background-color: var(--light-bg);
            padding: 8px 12px;
            border-radius: 6px;
        }
        /* Estilos para loaders */
        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: var(--border-radius);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loader-container.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loader {
            border: 4px solid rgba(67, 97, 238, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para selectores */
        .selector {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            color: var(--dark-text);
            background-color: white;
            cursor: pointer;
        }
        
        .selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        /* Estilos para gráficas */
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        /* Estilos para badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success {
            background-color: rgba(42, 157, 143, 0.2);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(233, 196, 106, 0.2);
            color: #d68102;
        }
        
        .badge-info {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--info-color);
        }
        
        /* Estilos para destacar el proponente (clickeable) */
        .proponente {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }
        
        .proponente:hover {
            text-decoration: none;
        }

        /* Estilos para enlace de votos (clickeable) */
            .votos-link {
                color: var(--primary-color);
                text-decoration: underline;
                cursor: pointer;
                font-weight: 500;
            }

            .votos-link:hover {
                text-decoration: none;
            }
                    
        /* Estilos para inputs de búsqueda */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        /* Media queries para responsividad */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .module {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-container {
                margin-bottom: 15px;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .logo-img {
                max-width: 100px;
            }
        }

        /* Añade estos estilos específicos para los módulos de Votos por Tienda y Búsqueda por Empleado */
        #empleado-result {
    max-height: 250px;
    overflow-y: auto;
    display: block;
        }

        /* El tbody debe tener propiedades normales de tabla */
        #tiendas-body {
            display: table-row-group;
            max-height: none;
            overflow-y: visible;
        }


        /* Alinear columnas de números */
.table-container th[width="80"],
.table-container td:nth-child(2),
.table-container td:nth-child(3) {
    text-align: center;
}



        /* Modificar los módulos de Votos por Tienda y Búsqueda por Empleado para que tengan altura fija */
.module[style*="grid-column: span 1"] {
    height: 400px;  /* Altura fija para ambos módulos */
    display: flex;
    flex-direction: column;
}

.module[style*="grid-column: span 1"] .table-container {
    flex-grow: 1;
    overflow-y: auto;
}

.module[style*="grid-column: span 1"] #empleado-result {
    flex-grow: 1;
    overflow-y: auto;
}


/* Ajustar alineación de las columnas en la tabla de propuestas */
#top-propuestas-body td:nth-child(2),
.table-container th:nth-child(2) {
    text-align: left;
    width: 30%; /* Ancho para la columna Nombre Propuesto */
    padding-left: 15px; /* Espacio a la izquierda */
}

#top-propuestas-body td:nth-child(3),
.table-container th:nth-child(3) {
    text-align: left;
    width: 25%; /* Ancho para la columna Proponente */
}

/* Asegurar que la primera columna (Posición) tenga un ancho fijo */
#top-propuestas-body td:first-child,
.table-container th:first-child {
    width: 60px;
    text-align: center;
}

/* Asegurar que la columna de Votos tenga un ancho fijo */
#top-propuestas-body td:nth-child(4),
.table-container th:nth-child(4) {
    width: 80px;
    text-align: center;
}

/* Asegurar que la columna de Último Voto tenga un ancho fijo */
#top-propuestas-body td:nth-child(5),
.table-container th:nth-child(5) {
    width: 140px;
    text-align: center;
}
    </style>

</head>
<body>
    <div class="container">
        <!-- Cabecera -->
        <header>
            <div class="logo-container">
                <img src="logograndeponlenombrealaapp.jpg" alt="Logo VotApp" class="logo-img">
                <div class="title-container">
                    <h1>Dashboard de Monitoreo</h1>
                    <div class="subtitle">Sistema de Votación - App del Gerente</div>
                </div>
            </div>
        </header>
        
        <!-- Módulo de Estadísticas Generales -->
        <div class="module">
            <div class="module-header">
                <h2 class="module-title">Estadísticas Generales</h2>
                <div class="module-actions">
                    <button id="refresh-stats" class="btn btn-primary btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Actualizar
                    </button>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="total-participantes">--</div>
                    <div class="stat-label">Participantes</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="total-propuestas">--</div>
                    <div class="stat-label">Propuestas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="total-votos">--</div>
                    <div class="stat-label">Votos Totales</div>
                </div>
            </div>
            
            <!-- Loader para estadísticas -->
            <div class="loader-container" id="stats-loader">
                <div class="loader"></div>
            </div>
        </div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Módulo de Top Propuestas -->
            <div class="module" style="grid-column: 1 / -1;">
                <div class="module-header">
                    <h2 class="module-title">Top Propuestas</h2>
                    <div class="module-actions">
                        <select id="top-selector" class="selector">
                            <option value="10">Top 10</option>
                            <option value="20">Top 20</option>
                            <option value="30">Top 30</option>
                            <option value="50">Top 50</option>
                            <option value="all">Todas</option>
                        </select>
                        <button id="refresh-top" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Actualizar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="60">Pos.</th>
                                <th>Nombre Propuesto</th>
                                <th>Proponente</th>
                                <th width="100">Votos</th>
                                <th width="180">Último Voto</th>
                            </tr>
                        </thead>
                        <tbody id="top-propuestas-body">
                            <!-- Aquí se cargarán dinámicamente las propuestas -->
                            <tr>
                                <td colspan="5" style="text-align: center;">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Loader para top propuestas -->
                <div class="loader-container" id="top-loader">
                    <div class="loader"></div>
                </div>
            </div>
            
            <!-- Módulo de Votos por Día -->
            <div class="module" style="grid-column: 1 / -1;">
                <div class="module-header">
                    <h2 class="module-title">Votos por Día</h2>
                    <div class="module-actions">
                        <select id="date-range" class="selector">
                            <option value="7">Últimos 7 días</option>
                            <option value="15">Últimos 15 días</option>
                            <option value="30" selected>Últimos 30 días</option>
                            <option value="all">Todo el periodo</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <button id="refresh-chart" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Actualizar
                        </button>
                    </div>
                </div>
                
                <!-- Selector de fechas personalizado (inicialmente oculto) -->
                <div id="custom-date-range" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="flex: 1;">
                            <label for="date-from" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Desde:</label>
                            <input type="date" id="date-from" class="search-input" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label for="date-to" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Hasta:</label>
                            <input type="date" id="date-to" class="search-input" style="width: 100%;">
                        </div>
                        <div style="align-self: flex-end;">
                            <button id="apply-date-range" class="btn btn-primary btn-sm">Aplicar</button>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="votes-chart"></canvas>
                </div>
                
                <!-- Loader para gráfica -->
                <div class="loader-container" id="chart-loader">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- Módulo de Votos por Tienda -->
            <div class="module" style="grid-column: span 1;">
                <div class="module-header">
                    <h2 class="module-title">Votos por Tienda</h2>
                    <div class="module-actions">
                        <button id="refresh-tiendas" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Actualizar
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tienda</th>
                                <th width="80">Votos</th>
                                <th width="80">%</th>
                            </tr>
                        </thead>
                        <tbody id="tiendas-body">
                            <!-- Aquí se cargarán dinámicamente las tiendas -->
                            <tr>
                                <td colspan="3" style="text-align: center;">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Loader para tiendas -->
                <div class="loader-container" id="tiendas-loader">
                    <div class="loader"></div>
                </div>
            </div>
            
            <!-- Módulo de Búsqueda por Empleado -->
            <div class="module" style="grid-column: span 1;">
                <div class="module-header">
                    <h2 class="module-title">Búsqueda por Empleado</h2>
                </div>
                
                <div class="search-container">
                    <input type="text" id="empleado-search" class="search-input" placeholder="Número de empleado">
                    <button id="search-empleado" class="btn btn-primary">Buscar</button>
                </div>
                
                <div id="empleado-result" style="display: none;">
                    <div class="detail-item">
                        <div class="detail-label">Nombre:</div>
                        <div class="detail-value" id="empleado-nombre">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Tienda:</div>
                        <div class="detail-value" id="empleado-tienda">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Participación:</div>
                        <div class="detail-value" id="empleado-participacion">--</div>
                    </div>
                    
                    <div class="detail-item" id="propuesta-container" style="display: none;">
                        <div class="detail-label">Propuesta Realizada:</div>
                        <div class="detail-value" id="empleado-propuesta">--</div>
                    </div>
                </div>
                
                <div id="empleado-not-found" style="display: none; text-align: center; margin-top: 20px; color: var(--danger-color);">
                    No se encontró información para este empleado.
                </div>
                
                <!-- Loader para búsqueda -->
                <div class="loader-container" id="search-loader">
                    <div class="loader"></div>
                </div>
            </div>
        </div>

        <!-- Modal para detalles del proponente -->
        <div class="modal-overlay" id="proponente-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Detalles del Proponente</h3>
                    <button class="modal-close" id="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="detail-item">
                        <div class="detail-label">Número de Empleado:</div>
                        <div class="detail-value" id="modal-empleado">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Nombre:</div>
                        <div class="detail-value" id="modal-nombre">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Tienda:</div>
                        <div class="detail-value" id="modal-tienda">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Nombre Propuesto:</div>
                        <div class="detail-value" id="modal-propuesta">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Fecha de Propuesta:</div>
                        <div class="detail-value" id="modal-fecha">--</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Votos Actuales:</div>
                        <div class="detail-value" id="modal-votos">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para detalles de los votantes -->
<div class="modal-overlay" id="votantes-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Detalle de Votantes</h3>
            <button class="modal-close" id="close-votantes-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-item">
                <div class="detail-label">Propuesta:</div>
                <div class="detail-value" id="modal-propuesta-nombre">--</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Total de Votos:</div>
                <div class="detail-value" id="modal-total-votos">--</div>
            </div>
            <div class="detail-label">Listado de Votantes:</div>
            <div class="table-container" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tienda</th>
                            <th>Fecha de Voto</th>
                        </tr>
                    </thead>
                    <tbody id="votantes-list">
                        <!-- Aquí se cargarán dinámicamente los votantes -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
    
    <!-- Chart.js para gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Firebase (Versión modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            orderBy, 
            limit,
            getDocs, 
            getDoc, 
            doc,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        
        // Configuración de Firebase (usar la misma que en la aplicación principal)
        const firebaseConfig = {
            apiKey: "AIzaSyAFMp3BbMM-indcX7FWlrTFFoEX4vG-Kt8",
            authDomain: "sistemavotaciones-b0bba.firebaseapp.com",
            projectId: "sistemavotaciones-b0bba",
            storageBucket: "sistemavotaciones-b0bba.firebasestorage.app",
            messagingSenderId: "203898236463",
            appId: "1:203898236463:web:18a14b0b282cc43544e0da"
        };

        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Referencias a elementos DOM
        const statsLoader = document.getElementById('stats-loader');
        const topLoader = document.getElementById('top-loader');
        const chartLoader = document.getElementById('chart-loader');
        const tiendasLoader = document.getElementById('tiendas-loader');
        const searchLoader = document.getElementById('search-loader');
        const proponenteModal = document.getElementById('proponente-modal');
        
        // Botones de actualización
        const refreshStats = document.getElementById('refresh-stats');
        const refreshTop = document.getElementById('refresh-top');
        const refreshChart = document.getElementById('refresh-chart');
        const refreshTiendas = document.getElementById('refresh-tiendas');
        const searchEmpleado = document.getElementById('search-empleado');
        
        // Selectores
        const topSelector = document.getElementById('top-selector');
        const dateRange = document.getElementById('date-range');
        
        // Variables para gráfica
        let votesChart;
        
        // Función para mostrar/ocultar loader
        function toggleLoader(loader, show) {
            if (show) {
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }
        
        // Función para formatear fechas
        function formatDate(timestamp) {
            if (!timestamp) return 'No disponible';
            
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Función para cargar estadísticas generales
        async function loadStats() {
            toggleLoader(statsLoader, true);
            
            try {
                // Contar propuestas
                const propuestasRef = collection(db, 'propuestas');
                const propuestasSnapshot = await getDocs(propuestasRef);
                const totalPropuestas = propuestasSnapshot.size;
                
                // Contar votos (total de documentos en la colección votos)
                const votosRef = collection(db, 'votos');
                const votosSnapshot = await getDocs(votosRef);
                const totalVotos = votosSnapshot.size;
                
                // Contar participantes únicos (empleados únicos en la colección votos)
                const empleadosUnicos = new Set();
                votosSnapshot.forEach(doc => {
                    const empleadoId = doc.data().empleadoId;
                    if (empleadoId) empleadosUnicos.add(empleadoId);
                });
                const totalParticipantes = empleadosUnicos.size;
                
                // Actualizar UI
                document.getElementById('total-propuestas').textContent = totalPropuestas;
                document.getElementById('total-votos').textContent = totalVotos;
                document.getElementById('total-participantes').textContent = totalParticipantes;
            } catch (error) {
                console.error("Error al cargar estadísticas:", error);
                alert("Error al cargar estadísticas. Intenta nuevamente.");
            } finally {
                toggleLoader(statsLoader, false);
            }
        }
        
        // Función para cargar top propuestas
        async function loadTopPropuestas() {
            toggleLoader(topLoader, true);
            
            try {
                const topLimit = topSelector.value === 'all' ? 1000 : parseInt(topSelector.value);
                
                // Obtener propuestas ordenadas por votos
                const propuestasRef = collection(db, 'propuestas');
                const q = query(propuestasRef, orderBy('votos', 'desc'), limit(topLimit));
                const propuestasSnapshot = await getDocs(q);
                
                const propuestasTableBody = document.getElementById('top-propuestas-body');
                propuestasTableBody.innerHTML = '';
                
                if (propuestasSnapshot.empty) {
                    propuestasTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay propuestas registradas</td></tr>';
                    toggleLoader(topLoader, false);
                    return;
                }
                
                // Procesar cada propuesta
                let position = 1;
                for (const doc of propuestasSnapshot.docs) {
                    const propuesta = doc.data();
                    propuesta.id = doc.id;
                    
                    // Encontrar el último voto para esta propuesta
                    const votosRef = collection(db, 'votos');
                    const votosQuery = query(votosRef, where('propuestaId', '==', propuesta.id), orderBy('fechaVoto', 'desc'), limit(1));
                    const votosSnapshot = await getDocs(votosQuery);
                    
                    let ultimoVoto = { fechaVoto: null };
                    if (!votosSnapshot.empty) {
                        ultimoVoto = votosSnapshot.docs[0].data();
                    }
                    
                    // Encontrar al proponente (primer voto para esta propuesta)
                    const proponenteQuery = query(votosRef, where('propuestaId', '==', propuesta.id), orderBy('fechaVoto', 'asc'), limit(1));
                    const proponenteSnapshot = await getDocs(proponenteQuery);
                    
                    let proponente = { nombre: 'Desconocido', empleadoId: null };
                    if (!proponenteSnapshot.empty) {
                        proponente = proponenteSnapshot.docs[0].data();
                    }

                    // Crear fila de la tabla
                    const row = document.createElement('tr');
                    
                    // Clase para destacar el podio
                    const rankingClass = position <= 3 ? `ranking-${position}` : '';
                    
                    row.innerHTML = `
                        <td><span class="ranking ${rankingClass}">${position}</span></td>
                        <td>${propuesta.nombre || 'Sin nombre'}</td>
                        <td><span class="proponente" data-id="${propuesta.id}">${proponente.nombre || 'Desconocido'}</span></td>
                       <td><span class="votos-link" data-id="${propuesta.id}">${propuesta.votos || 0}</span></td>
                        <td>${formatDate(ultimoVoto.fechaVoto)}</td>
                    `;
                    
                    propuestasTableBody.appendChild(row);
                    position++;
                }
                
                // Añadir eventos a los nombres de proponentes
                document.querySelectorAll('.proponente').forEach(element => {
                    element.addEventListener('click', showProponenteDetails);
                });


                                // Añadir eventos a los enlaces de votos
                document.querySelectorAll('.votos-link').forEach(element => {
                    element.addEventListener('click', showVotantesDetails);
                });


            } catch (error) {
                console.error("Error al cargar top propuestas:", error);
                document.getElementById('top-propuestas-body').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center;">Error al cargar datos. Intenta nuevamente.</td></tr>';
            } finally {
                toggleLoader(topLoader, false);
            }
        }
        
        // Función para mostrar detalles del proponente
        async function showProponenteDetails() {
            const propuestaId = this.getAttribute('data-id');
            toggleLoader(topLoader, true);
            
            try {
                // Obtener la propuesta
                const propuestaRef = doc(db, 'propuestas', propuestaId);
                const propuestaDoc = await getDoc(propuestaRef);
                
                if (!propuestaDoc.exists()) {
                    alert("No se encontró la propuesta");
                    toggleLoader(topLoader, false);
                    return;
                }
                
                const propuesta = propuestaDoc.data();
                
                // Encontrar al proponente (primer voto para esta propuesta)
                const votosRef = collection(db, 'votos');
                const proponenteQuery = query(votosRef, where('propuestaId', '==', propuestaId), orderBy('fechaVoto', 'asc'), limit(1));
                const proponenteSnapshot = await getDocs(proponenteQuery);
                
                if (proponenteSnapshot.empty) {
                    alert("No se encontró información del proponente");
                    toggleLoader(topLoader, false);
                    return;
                }
                
                const proponente = proponenteSnapshot.docs[0].data();
                
                // Actualizar contenido del modal
                document.getElementById('modal-empleado').textContent = proponente.empleadoId || 'No disponible';
                document.getElementById('modal-nombre').textContent = proponente.nombre || 'No disponible';
                document.getElementById('modal-tienda').textContent = proponente.tienda || 'No disponible';
                document.getElementById('modal-propuesta').textContent = propuesta.nombre || 'No disponible';
                document.getElementById('modal-fecha').textContent = formatDate(proponente.fechaVoto);
                document.getElementById('modal-votos').textContent = propuesta.votos || 0;
                
                // Mostrar modal
                proponenteModal.classList.add('active');
            } catch (error) {
                console.error("Error al obtener detalles del proponente:", error);
                alert("Error al cargar detalles. Intenta nuevamente.");
            } finally {
                toggleLoader(topLoader, false);
            }
        }


        // Función para mostrar detalles de los votantes
async function showVotantesDetails() {
    const propuestaId = this.getAttribute('data-id');
    toggleLoader(topLoader, true);
    
    try {
        // Obtener la propuesta
        const propuestaRef = doc(db, 'propuestas', propuestaId);
        const propuestaDoc = await getDoc(propuestaRef);
        
        if (!propuestaDoc.exists()) {
            alert("No se encontró la propuesta");
            toggleLoader(topLoader, false);
            return;
        }
        
        const propuesta = propuestaDoc.data();
        
        // Obtener todos los votos para esta propuesta
        const votosRef = collection(db, 'votos');
        const votantesQuery = query(votosRef, where('propuestaId', '==', propuestaId), orderBy('fechaVoto', 'desc'));
        const votantesSnapshot = await getDocs(votantesQuery);
        
        // Actualizar contenido del modal
        document.getElementById('modal-propuesta-nombre').textContent = propuesta.nombre || 'No disponible';
        document.getElementById('modal-total-votos').textContent = propuesta.votos || 0;
        
        // Llenar la tabla de votantes
        const votantesList = document.getElementById('votantes-list');
        votantesList.innerHTML = '';
        
        if (votantesSnapshot.empty) {
            votantesList.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay información de votantes</td></tr>';
        } else {
            votantesSnapshot.forEach(doc => {
                const voto = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voto.nombre || 'No disponible'}</td>
                    <td>${voto.tienda || 'No disponible'}</td>
                    <td>${formatDate(voto.fechaVoto)}</td>
                `;
                votantesList.appendChild(row);
            });
        }
        
        // Mostrar modal
        document.getElementById('votantes-modal').classList.add('active');
    } catch (error) {
        console.error("Error al obtener detalles de los votantes:", error);
        alert("Error al cargar detalles de votantes. Intenta nuevamente.");
    } finally {
        toggleLoader(topLoader, false);
    }
}



        // Función para cargar votos por día
        async function loadVotesChart() {
            toggleLoader(chartLoader, true);
            
            try {
                // Determinar rango de fechas
                const rangeValue = dateRange.value;
                let fromDate = null;
                let toDate = new Date();
                
                if (rangeValue !== 'all' && rangeValue !== 'custom') {
                    const days = parseInt(rangeValue);
                    fromDate = new Date();
                    fromDate.setDate(fromDate.getDate() - days);
                } else if (rangeValue === 'custom') {
                    fromDate = document.getElementById('date-from').valueAsDate;
                    toDate = document.getElementById('date-to').valueAsDate || new Date();
                    
                    if (!fromDate) {
                        alert("Por favor selecciona una fecha inicial");
                        toggleLoader(chartLoader, false);
                        return;
                    }
                }
                
                // Consultar votos
                const votosRef = collection(db, 'votos');
                let q = query(votosRef, orderBy('fechaVoto', 'asc'));
                const votosSnapshot = await getDocs(q);
                
                // Procesar votos por día
                const votosPorDia = {};
                
                votosSnapshot.forEach(doc => {
                    const voto = doc.data();
                    if (!voto.fechaVoto) return;
                    
                    const votoDate = new Date(voto.fechaVoto.seconds * 1000);
                    
                    // Filtrar por rango de fechas
                    if (fromDate && votoDate < fromDate) return;
                    if (votoDate > toDate) return;
                    
                    // Agrupar por día
                    const dateKey = votoDate.toISOString().split('T')[0];
                    votosPorDia[dateKey] = (votosPorDia[dateKey] || 0) + 1;
                });
                
                // Preparar datos para Chart.js
                const labels = Object.keys(votosPorDia).sort();
                const data = labels.map(date => votosPorDia[date]);
                
                // Actualizar o crear gráfica
                const ctx = document.getElementById('votes-chart').getContext('2d');
                
                if (votesChart) {
                    votesChart.data.labels = labels;
                    votesChart.data.datasets[0].data = data;
                    votesChart.update();
                } else {
                    votesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Votos',
                                data: data,
                                borderColor: '#4361ee',
                                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                                tension: 0.2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: (items) => {
                                            const date = new Date(items[0].label);
                                            return date.toLocaleDateString('es-ES', {
                                                day: '2-digit',
                                                month: '2-digit',
                                                year: 'numeric'
                                            });
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error("Error al cargar gráfica de votos:", error);
                alert("Error al cargar la gráfica. Intenta nuevamente.");
            } finally {
                toggleLoader(chartLoader, false);
            }
        }


        // Cargar votos por tienda
        async function loadVotosPorTienda() {
            toggleLoader(tiendasLoader, true);
            
            try {
                // Consultar todos los votos
                const votosRef = collection(db, 'votos');
                const votosSnapshot = await getDocs(votosRef);
                
                // Agrupar por tienda
                const votosPorTienda = {};
                let totalVotos = 0;
                
                votosSnapshot.forEach(doc => {
                    const voto = doc.data();
                    const tienda = voto.tienda || 'No especificada';
                    
                    votosPorTienda[tienda] = (votosPorTienda[tienda] || 0) + 1;
                    totalVotos++;
                });
                
                // Ordenar tiendas por número de votos
                const tiendas = Object.keys(votosPorTienda).map(tienda => ({
                    nombre: tienda,
                    votos: votosPorTienda[tienda],
                    porcentaje: ((votosPorTienda[tienda] / totalVotos) * 100).toFixed(1)
                }));
                
                tiendas.sort((a, b) => b.votos - a.votos);
                
                // Actualizar tabla
                const tiendasBody = document.getElementById('tiendas-body');
                tiendasBody.innerHTML = '';
                
                if (tiendas.length === 0) {
                    tiendasBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay datos disponibles</td></tr>';
                    return;
                }
                
                tiendas.forEach(tienda => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tienda.nombre}</td>
                        <td>${tienda.votos}</td>
                        <td>${tienda.porcentaje}%</td>
                    `;
                    tiendasBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error al cargar votos por tienda:", error);
                document.getElementById('tiendas-body').innerHTML = 
                    '<tr><td colspan="3" style="text-align: center;">Error al cargar datos. Intenta nuevamente.</td></tr>';
            } finally {
                toggleLoader(tiendasLoader, false);
            }
        }
        
        // Buscar empleado
        async function searchEmpleadoById() {
            const empleadoId = document.getElementById('empleado-search').value.trim();
            
            if (!empleadoId) {
                alert("Por favor ingresa un número de empleado");
                return;
            }
            
            toggleLoader(searchLoader, true);
            document.getElementById('empleado-result').style.display = 'none';
            document.getElementById('empleado-not-found').style.display = 'none';
            document.getElementById('propuesta-container').style.display = 'none';
            
            try {
                // Buscar voto del empleado
                const votosRef = collection(db, 'votos');
                const q = query(votosRef, where('empleadoId', '==', empleadoId));
                const votosSnapshot = await getDocs(q);
                
                if (votosSnapshot.empty) {
                    document.getElementById('empleado-not-found').style.display = 'block';
                    toggleLoader(searchLoader, false);
                    return;
                }
                
                // Obtener datos del empleado
                const empleadoData = votosSnapshot.docs[0].data();
                
                document.getElementById('empleado-nombre').textContent = empleadoData.nombre || 'No disponible';
                document.getElementById('empleado-tienda').textContent = empleadoData.tienda || 'No disponible';
                
                const fechaVoto = empleadoData.fechaVoto ? 
                    `Votó el ${formatDate(empleadoData.fechaVoto)}` : 'Fecha de voto no disponible';
                
                document.getElementById('empleado-participacion').textContent = fechaVoto;
                
                // Verificar si propuso algún nombre
                const propuestasRef = collection(db, 'propuestas');
                const propuestasQuery = query(propuestasRef);
                const propuestasSnapshot = await getDocs(propuestasQuery);
                
                let propuestaEncontrada = false;
                
                for (const propuestaDoc of propuestasSnapshot.docs) {
                    const propuestaId = propuestaDoc.id;
                    
                    // Buscar el primer voto para esta propuesta
                    const primerVotoQuery = query(
                        votosRef, 
                        where('propuestaId', '==', propuestaId),
                        orderBy('fechaVoto', 'asc'),
                        limit(1)
                    );
                    
                    const primerVotoSnapshot = await getDocs(primerVotoQuery);
                    
                    if (!primerVotoSnapshot.empty) {
                        const primerVoto = primerVotoSnapshot.docs[0].data();
                        
                        if (primerVoto.empleadoId === empleadoId) {
                            propuestaEncontrada = true;
                            document.getElementById('empleado-propuesta').textContent = 
                                `"${propuestaDoc.data().nombre}" (${propuestaDoc.data().votos || 0} votos)`;
                            document.getElementById('propuesta-container').style.display = 'block';
                            break;
                        }
                    }
                }
                
                document.getElementById('empleado-result').style.display = 'block';
            } catch (error) {
                console.error("Error al buscar empleado:", error);
                alert("Error al buscar información del empleado. Intenta nuevamente.");
            } finally {
                toggleLoader(searchLoader, false);
            }
        }
        
        // Event Listeners
        window.addEventListener('DOMContentLoaded', () => {
            // Cargar datos iniciales
            loadStats();
            loadTopPropuestas();
            loadVotesChart();
            loadVotosPorTienda();
            
            // Botones de actualización
            refreshStats.addEventListener('click', loadStats);
            refreshTop.addEventListener('click', loadTopPropuestas);
            refreshChart.addEventListener('click', loadVotesChart);
            refreshTiendas.addEventListener('click', loadVotosPorTienda);
            searchEmpleado.addEventListener('click', searchEmpleadoById);
            
            // Cambio en selectors
            topSelector.addEventListener('change', loadTopPropuestas);
            dateRange.addEventListener('change', function() {
                const customDateRange = document.getElementById('custom-date-range');
                customDateRange.style.display = this.value === 'custom' ? 'block' : 'none';
                
                if (this.value !== 'custom') {
                    loadVotesChart();
                }
            });
            
            // Aplicar rango de fechas personalizado
            document.getElementById('apply-date-range').addEventListener('click', loadVotesChart);
            
            // Cerrar modal
            document.getElementById('close-modal').addEventListener('click', () => {
                proponenteModal.classList.remove('active');
            });
            
            // Cerrar modal al hacer clic fuera
            proponenteModal.addEventListener('click', (e) => {
                if (e.target === proponenteModal) {
                    proponenteModal.classList.remove('active');
                }
            });


            // Cerrar modal de votantes
            document.getElementById('close-votantes-modal').addEventListener('click', () => {
                document.getElementById('votantes-modal').classList.remove('active');
            });

            // Cerrar modal de votantes al hacer clic fuera
            document.getElementById('votantes-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('votantes-modal')) {
                    document.getElementById('votantes-modal').classList.remove('active');
                }
            });
            
            // Establecer fecha actual en selectores de fecha
            const today = new Date();
            const dateToInput = document.getElementById('date-to');
            dateToInput.valueAsDate = today;
            
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const dateFromInput = document.getElementById('date-from');
            dateFromInput.valueAsDate = oneMonthAgo;
        });
    </script>
</body>
</html>